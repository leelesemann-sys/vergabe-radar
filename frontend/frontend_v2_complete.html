<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VergabeRadar V2 - Vollst√§ndig</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 30px; color: #333; }
        .search-box { margin-bottom: 20px; }
        #searchInput { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        select, input[type="date"], input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .button-group { margin-bottom: 20px; }
        button { padding: 12px 25px; background: #0066cc; color: white; border: none; border-radius: 4px; font-size: 15px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #0052a3; }
        #resetBtn { background: #666; }
        #resetBtn:hover { background: #444; }
        .stats { margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 4px; font-size: 14px; }
        .results { margin-top: 20px; }
        .result-item { border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 4px; background: white; }
        .result-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .result-title { font-size: 18px; font-weight: bold; color: #0066cc; margin-bottom: 10px; }
        .result-meta { color: #666; font-size: 13px; margin-bottom: 10px; line-height: 1.6; }
        .result-description { color: #333; line-height: 1.6; margin-bottom: 10px; font-size: 14px; }
        .result-score { color: #0066cc; font-weight: bold; font-size: 13px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #fee; color: #c00; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .filter-section { border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 15px; }
        .filter-section h3 { margin-bottom: 10px; color: #333; font-size: 16px; }
        .radius-options { display: flex; gap: 10px; margin-top: 10px; }
        .radius-btn { padding: 8px 15px; background: #eee; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .radius-btn.active { background: #0066cc; color: white; border-color: #0066cc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç VergabeRadar V2 - Vollst√§ndige Suche</h1>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Suche... (z.B. 'Cloud Migration', 'IT-Dienstleistung')">
        </div>

        <div class="filter-section">
            <h3>üìç Standort-Filter</h3>
            <div class="filters">
                <div class="filter-group">
                    <label>PLZ f√ºr Umkreissuche</label>
                    <input type="text" id="plzInput" placeholder="z.B. 80331" maxlength="5">
                </div>
                <div class="filter-group">
                    <label>Umkreis (km)</label>
                    <div class="radius-options">
                        <button type="button" class="radius-btn" data-radius="10">10km</button>
                        <button type="button" class="radius-btn" data-radius="25">25km</button>
                        <button type="button" class="radius-btn" data-radius="50">50km</button>
                        <button type="button" class="radius-btn" data-radius="100">100km</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Bundesland</label>
                    <select id="bundeslandFilter">
                        <option value="">Alle Bundesl√§nder</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stadt</label>
                    <select id="cityFilter">
                        <option value="">Alle St√§dte</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h3>üìã Kategorie-Filter</h3>
            <div class="filters">
                <div class="filter-group">
                    <label>Auftragsart</label>
                    <select id="contractNatureFilter">
                        <option value="">Alle Auftragsarten</option>
                        <option value="services">Dienstleistungen</option>
                        <option value="works">Bauleistungen</option>
                        <option value="supplies">Lieferleistungen</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Vergabeverordnung</label>
                    <select id="legalBasisFilter">
                        <option value="">Alle Verordnungen</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>CPV-Code</label>
                    <select id="cpvFilter">
                        <option value="">Alle Kategorien</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Auftraggeber</label>
                    <select id="buyerFilter">
                        <option value="">Alle Auftraggeber</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h3>üìÖ Weitere Filter</h3>
            <div class="filters">
                <div class="filter-group">
                    <label>Datum ab</label>
                    <input type="date" id="dateFrom">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button onclick="search()">üîç Suchen</button>
            <button id="resetBtn" onclick="reset()">üîÑ Zur√ºcksetzen</button>
        </div>

        <div class="stats" id="stats" style="display:none;"></div>
        <div class="error" id="error" style="display:none;"></div>
        <div class="loading" id="loading" style="display:none;">Suche l√§uft...</div>
        <div class="results" id="results"></div>
    </div>

    <script>
        const CONFIG = {
            searchEndpoint: 'https://vergaberadar-search.search.windows.net',
            indexName: 'vergaberadar-semantic',
            apiKey: 'DEIN-QUERY-KEY-HIER',
            apiVersion: '2024-07-01'
        };

        // VERGABEVERORDNUNG MAPPING
        const LEGAL_BASIS = {
            "32014L0024": "EU-Weit (RL 2014/24/EU)",
            "de-vob": "VOB/A",
            "32014L0025": "EU-Weit (RL 2014/25/EU - Sektoren)",
            "de-vol": "VOL/A",
            "de-uvgo": "UVgO",
            "32009L0081": "EU (Verteidigung)",
            "other": "Sonstige",
            "32007R1370": "EU-VO 1370/2007",
            "32014L0023": "EU (Konzessionen)",
            "de-hhr": "Hamburg Regional"
        };

        // BUNDESLAND MAPPING (NUTS‚ÜíBundesland)
        const BUNDESLAND_NUTS = {
            "DE1": "Baden-W√ºrttemberg",
            "DE2": "Bayern",
            "DE3": "Berlin",
            "DE4": "Brandenburg",
            "DE5": "Bremen",
            "DE6": "Hamburg",
            "DE7": "Hessen",
            "DE8": "Mecklenburg-Vorpommern",
            "DE9": "Niedersachsen",
            "DEA": "Nordrhein-Westfalen",
            "DEB": "Rheinland-Pfalz",
            "DEC": "Saarland",
            "DED": "Sachsen",
            "DEE": "Sachsen-Anhalt",
            "DEF": "Schleswig-Holstein",
            "DEG": "Th√ºringen"
        };

        // PLZ-KOORDINATEN (Top 100 deutsche PLZs)
        const PLZ_COORDS = {
            "10115": [52.5200, 13.4050], "20095": [53.5511, 9.9937], "80331": [48.1351, 11.5820],
            "50667": [50.9375, 6.9603], "60311": [50.1109, 8.6821], "70173": [48.7758, 9.1829],
            "40213": [51.2277, 6.7735], "44135": [51.5136, 7.4653], "45127": [51.4556, 7.0116],
            "04109": [51.3397, 12.3731], "28195": [53.0793, 8.8017], "01067": [51.0504, 13.7373],
            "30159": [52.3759, 9.7320], "90403": [49.4521, 11.0767], "68159": [49.4875, 8.4660],
            "76131": [49.0069, 8.4037], "86150": [48.3705, 10.8978], "65183": [50.0826, 8.2400],
            "47051": [51.4344, 6.7623], "38100": [52.2689, 10.5268]
        };

        let selectedRadius = null;
        let allResults = [];

        // HAVERSINE DISTANZ-BERECHNUNG
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // RADIUS BUTTONS
        document.querySelectorAll('.radius-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedRadius = parseInt(this.dataset.radius);
            });
        });

        // SUCHE
        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) { alert('Bitte Suchbegriff eingeben'); return; }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('error').style.display = 'none';
            document.getElementById('stats').style.display = 'none';

            const filter = buildFilter();
            const startTime = performance.now();

            try {
                const url = `${CONFIG.searchEndpoint}/indexes/${CONFIG.indexName}/docs/search?api-version=${CONFIG.apiVersion}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'api-key': CONFIG.apiKey },
                    body: JSON.stringify({
                        search: query,
                        queryType: 'semantic',
                        semanticConfiguration: 'vergaberadar-semantic-config',
                        top: 100,
                        select: '*',
                        filter: filter || undefined
                    })
                });

                if (!response.ok) throw new Error(`API Fehler: ${response.status}`);
                
                const data = await response.json();
                allResults = data.value;

                // CLIENT-SIDE PLZ-UMKREIS-FILTER
                const plz = document.getElementById('plzInput').value.trim();
                if (plz && selectedRadius && PLZ_COORDS[plz]) {
                    const [lat1, lng1] = PLZ_COORDS[plz];
                    allResults = allResults.filter(doc => {
                        if (!doc.buyer_lat || !doc.buyer_lng) return false;
                        const dist = calculateDistance(lat1, lng1, doc.buyer_lat, doc.buyer_lng);
                        return dist <= selectedRadius;
                    });
                }

                displayResults(allResults, performance.now() - startTime);
            } catch (error) {
                document.getElementById('error').textContent = `Fehler: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function buildFilter() {
            let filters = [];
            
            const bundesland = document.getElementById('bundeslandFilter').value;
            if (bundesland) {
                filters.push(`search.ismatch('${bundesland}*', 'buyer_region')`);
            }
            
            const city = document.getElementById('cityFilter').value;
            if (city) filters.push(`buyer_city eq '${city}'`);
            
            const nature = document.getElementById('contractNatureFilter').value;
            if (nature) filters.push(`contract_nature eq '${nature}'`);
            
            const legal = document.getElementById('legalBasisFilter').value;
            if (legal) filters.push(`procedure_legal_basis eq '${legal}'`);
            
            const cpv = document.getElementById('cpvFilter').value;
            if (cpv) filters.push(`cpv_code eq '${cpv}'`);
            
            const buyer = document.getElementById('buyerFilter').value;
            if (buyer) filters.push(`buyer_name eq '${buyer}'`);
            
            const date = document.getElementById('dateFrom').value;
            if (date) filters.push(`publication_date ge ${date}T00:00:00Z`);
            
            return filters.join(' and ');
        }

        function displayResults(results, time) {
            const container = document.getElementById('results');
            document.getElementById('stats').innerHTML = `<strong>Ergebnisse:</strong> ${results.length} | <strong>Zeit:</strong> ${Math.round(time)}ms`;
            document.getElementById('stats').style.display = 'block';

            if (results.length === 0) {
                container.innerHTML = '<p style="padding:20px;text-align:center;">Keine Ergebnisse</p>';
                return;
            }

            container.innerHTML = results.map((doc, i) => `
                <div class="result-item">
                    <div class="result-title">${i + 1}. ${escapeHtml(doc.title || 'Ohne Titel')}</div>
                    <div class="result-meta">
                        üìç ${escapeHtml(doc.buyer_name || 'N/A')} 
                        ${doc.buyer_city ? '‚Ä¢ ' + escapeHtml(doc.buyer_city) : ''}
                        ${doc.buyer_postal_code ? '‚Ä¢ PLZ: ' + escapeHtml(doc.buyer_postal_code) : ''}
                        <br>
                        ${doc.contract_nature ? 'üì¶ ' + {'services':'Dienstleistungen','works':'Bauleistungen','supplies':'Lieferleistungen'}[doc.contract_nature] : ''}
                        ${doc.procedure_legal_basis ? '‚Ä¢ ‚öñÔ∏è ' + (LEGAL_BASIS[doc.procedure_legal_basis] || doc.procedure_legal_basis) : ''}
                        ${doc.cpv_code ? '‚Ä¢ üè∑Ô∏è ' + escapeHtml(doc.cpv_code) : ''}
                    </div>
                    <div class="result-description">${escapeHtml((doc.description || '').substring(0, 300))}...</div>
                    ${doc['@search.rerankerScore'] ? `<div class="result-score">Score: ${doc['@search.rerankerScore'].toFixed(2)}</div>` : ''}
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadFilters() {
            const bundeslandSelect = document.getElementById('bundeslandFilter');
            Object.entries(BUNDESLAND_NUTS).forEach(([code, name]) => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = name;
                bundeslandSelect.appendChild(opt);
            });

            const legalSelect = document.getElementById('legalBasisFilter');
            Object.entries(LEGAL_BASIS).forEach(([code, name]) => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = name;
                legalSelect.appendChild(opt);
            });

            ['cpvFilter', 'cityFilter', 'buyerFilter'].forEach(async (id) => {
                const field = id.replace('Filter', '').replace('cpv', 'cpv_code').replace('city', 'buyer_city').replace('buyer', 'buyer_name');
                const facets = await getFacets(field, 50);
                const select = document.getElementById(id);
                facets.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.value;
                    opt.textContent = `${item.value} (${item.count})`;
                    select.appendChild(opt);
                });
            });
        }

        async function getFacets(field, count = 20) {
            try {
                const url = `${CONFIG.searchEndpoint}/indexes/${CONFIG.indexName}/docs/search?api-version=${CONFIG.apiVersion}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'api-key': CONFIG.apiKey },
                    body: JSON.stringify({ search: '*', facets: [`${field},count:${count}`], top: 0 })
                });
                const data = await response.json();
                return data['@search.facets'][field] || [];
            } catch { return []; }
        }

        function reset() {
            document.getElementById('searchInput').value = '';
            document.getElementById('plzInput').value = '';
            selectedRadius = null;
            document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('select').forEach(s => s.value = '');
            document.getElementById('dateFrom').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });

        window.addEventListener('load', loadFilters);
    </script>
</body>
</html>
